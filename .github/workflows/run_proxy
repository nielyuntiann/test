name: Check IP, Setup Ngrok, Setup Transparent proxy, Run for 10 minutes 

on:
  workflow_dispatch:

jobs:
  setup-proxy:
    runs-on: ubuntu-latest
    steps:
      - name: Get public IP
        run: curl -s https://ifconfig.me

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip curl

      - name: Install proxy.py
        run: |
          pip install proxy.py

      - name: Start proxy.py
        run: |
          nohup proxy --hostname 0.0.0.0 --port 8080 &

      - name: Install ngrok
        run: |
          curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
            | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null \
            && echo "deb https://ngrok-agent.s3.amazonaws.com bookworm main" \
            | sudo tee /etc/apt/sources.list.d/ngrok.list \
            && sudo apt update \
            && sudo apt install -y ngrok

      - name: Configure ngrok
        run: |
          ngrok config add-authtoken 38e34Luh43j1csQO3fF6HKq02ul_2Q72nuQJAG6LuG1jneimq

      - name: Start ngrok tunnel
        run: |
          nohup ngrok http 8080 &

      - name: Keep job alive for 10 minutes
        run: sleep 600
